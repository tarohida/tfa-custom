<?php

/**
 * @file
 * TFA Customモジュール - TFAのリダイレクトとメール送信をカスタマイズ。
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;

/**
 * Implements hook_form_FORM_ID_alter() for tfa_entry_form.
 *
 * TFAログイン後のリダイレクト先をカスタマイズ。
 * エラーメッセージの日本語対応（時間表記の修正）。
 */
function tfa_custom_form_tfa_entry_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // カスタムsubmitハンドラーを追加してリダイレクトを制御。
  $form['#submit'][] = 'tfa_custom_entry_form_submit';

  // エラーメッセージの日本語対応のため、バリデーション後に処理。
  $form['#validate'][] = 'tfa_custom_fix_error_messages';
}

/**
 * カスタムバリデーションハンドラー: エラーメッセージの日本語対応。
 *
 * TFA のエラーメッセージ内の英語時間表記（例: "5 min", "10 sec"）を
 * 日本語表記（例: "5分", "10秒"）に変換。
 */
function tfa_custom_fix_error_messages(array &$form, FormStateInterface $form_state) {
  $errors = $form_state->getErrors();
  if (empty($errors)) {
    return;
  }

  // 日本語ロケールの場合のみ処理。
  $current_language = \Drupal::languageManager()->getCurrentLanguage()->getId();
  if ($current_language !== 'ja') {
    return;
  }

  // エラーメッセージを修正。
  $modified_errors = [];
  foreach ($errors as $name => $message) {
    $original_message = (string) $message;

    // 英語の時間表記を日本語に変換。
    $new_message = preg_replace_callback(
      '/(\d+)\s*(year|month|week|day|hour|min|sec)s?/',
      function ($matches) {
        $number = $matches[1];
        $unit = $matches[2];

        // 単位を日本語に変換。
        $units_map = [
          'year' => '年',
          'month' => 'ヶ月',
          'week' => '週間',
          'day' => '日',
          'hour' => '時間',
          'min' => '分',
          'sec' => '秒',
        ];

        return $number . ($units_map[$unit] ?? $unit);
      },
      $original_message
    );

    $modified_errors[$name] = $new_message;
  }

  // 変更があった場合のみ再設定。
  if ($modified_errors !== $errors) {
    $form_state->clearErrors();
    foreach ($modified_errors as $name => $message) {
      $form_state->setErrorByName($name, $message);
    }
  }
}

/**
 * カスタムsubmitハンドラー: TFAログイン後のリダイレクト。
 */
function tfa_custom_entry_form_submit(array &$form, FormStateInterface $form_state) {
  $config = \Drupal::config('tfa_custom.settings');
  $redirect_path = $config->get('redirect_after_login') ?: '<front>';

  // パスワードリセットトークンがある場合は元のリダイレクトを維持。
  $token = \Drupal::request()->get('pass-reset-token');
  if (!$token) {
    // カスタムリダイレクト先を設定。
    if ($redirect_path === '<front>') {
      $form_state->setRedirect('<front>');
    }
    else {
      // 相対パスから絶対URLを生成。
      try {
        $url = Url::fromUserInput($redirect_path);
        $form_state->setRedirectUrl($url);
      }
      catch (\Exception $e) {
        // 無効なパスの場合はフロントページにリダイレクト。
        \Drupal::logger('tfa_custom')->error('Invalid redirect path: @path', ['@path' => $redirect_path]);
        $form_state->setRedirect('<front>');
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for tfa_setup_form.
 *
 * TFA有効化時のメール送信を制御。
 */
function tfa_custom_form_tfa_setup_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // カスタムsubmitハンドラーを最初に追加してメール送信を制御。
  array_unshift($form['#submit'], 'tfa_custom_setup_form_submit');
}

/**
 * カスタムsubmitハンドラー: TFA有効化時のメール送信制御。
 */
function tfa_custom_setup_form_submit(array &$form, FormStateInterface $form_state) {
  $config = \Drupal::config('tfa_custom.settings');
  $send_email = $config->get('send_email_on_enable') ?? TRUE;

  // メール送信を無効にする場合、一時的にフラグを設定。
  if (!$send_email) {
    \Drupal::state()->set('tfa_custom.suppress_enable_email', TRUE);
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for tfa_disable_form.
 *
 * TFA無効化時のメール送信を制御。
 */
function tfa_custom_form_tfa_disable_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // カスタムsubmitハンドラーを最初に追加してメール送信を制御。
  array_unshift($form['#submit'], 'tfa_custom_disable_form_submit');
}

/**
 * カスタムsubmitハンドラー: TFA無効化時のメール送信制御。
 */
function tfa_custom_disable_form_submit(array &$form, FormStateInterface $form_state) {
  $config = \Drupal::config('tfa_custom.settings');
  $send_email = $config->get('send_email_on_disable') ?? TRUE;

  // メール送信を無効にする場合、一時的にフラグを設定。
  if (!$send_email) {
    \Drupal::state()->set('tfa_custom.suppress_disable_email', TRUE);
  }
}

/**
 * Implements hook_mail_alter().
 *
 * TFAのメール送信を制御。
 */
function tfa_custom_mail_alter(&$message) {
  // TFA有効化メールの制御。
  if ($message['module'] === 'tfa' && $message['key'] === 'tfa_enabled_configuration') {
    if (\Drupal::state()->get('tfa_custom.suppress_enable_email')) {
      // メール送信を抑制。
      $message['send'] = FALSE;
      \Drupal::state()->delete('tfa_custom.suppress_enable_email');
    }
  }

  // TFA無効化メールの制御。
  if ($message['module'] === 'tfa' && $message['key'] === 'tfa_disabled_configuration') {
    if (\Drupal::state()->get('tfa_custom.suppress_disable_email')) {
      // メール送信を抑制。
      $message['send'] = FALSE;
      \Drupal::state()->delete('tfa_custom.suppress_disable_email');
    }
  }
}

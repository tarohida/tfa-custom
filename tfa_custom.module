<?php

/**
 * @file
 * TFA Customモジュール - TFAのリダイレクトとメール送信をカスタマイズ。
 */

use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;
use Drupal\user\UserInterface;

/**
 * Implements hook_user_login().
 *
 * ログイン成功後（TFA検証後を含む）のリダイレクト先をカスタマイズ。
 */
function tfa_custom_user_login(UserInterface $account) {
  $config = \Drupal::config('tfa_custom.settings');
  $redirect_path = $config->get('redirect_after_login') ?: '<front>';

  // パスワードリセットトークンがある場合はリダイレクトしない。
  $token = \Drupal::request()->get('pass-reset-token');
  if ($token) {
    return;
  }

  // デフォルト設定の場合は何もしない（Drupalのデフォルト動作を使用）。
  if ($redirect_path === '<front>') {
    return;
  }

  // カスタムリダイレクト先を設定。
  try {
    $url = Url::fromUserInput($redirect_path);

    // ルートが存在するか確認。
    try {
      $route_provider = \Drupal::service('router.route_provider');
      $route_provider->getRouteByName($url->getRouteName());
    }
    catch (\Exception $route_exception) {
      // ルート名で確認できない場合、パスベースで確認。
      // 無効なパスの場合は例外がスローされる。
    }

    // リダイレクトを実行。
    $response = new RedirectResponse($url->toString());
    $response->send();
    exit;
  }
  catch (\Exception $e) {
    // 無効なパスの場合はログに記録し、デフォルト動作を使用。
    \Drupal::logger('tfa_custom')->error('Invalid redirect path: @path. Error: @error. Using default redirect.', [
      '@path' => $redirect_path,
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_mail_alter().
 *
 * TFAのメール送信を制御。
 */
function tfa_custom_mail_alter(&$message) {
  // TFAモジュールからのメールのみを対象とする。
  if ($message['module'] !== 'tfa') {
    return;
  }

  $config = \Drupal::config('tfa_custom.settings');

  // TFA有効化メールの制御。
  if ($message['key'] === 'tfa_enabled_configuration') {
    $send_email = $config->get('send_email_on_enable') ?? TRUE;
    if (!$send_email) {
      $message['send'] = FALSE;
    }
  }

  // TFA無効化メールの制御。
  if ($message['key'] === 'tfa_disabled_configuration') {
    $send_email = $config->get('send_email_on_disable') ?? TRUE;
    if (!$send_email) {
      $message['send'] = FALSE;
    }
  }
}

<?php

/**
 * @file
 * TFA Customモジュール - TFAのリダイレクトとメール送信をカスタマイズ。
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 *
 * ログインフォームに destination パラメータを追加してリダイレクトを制御。
 */
function tfa_custom_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // user_login_form のみに適用（TFA無効時のログイン用）。
  // TFA有効時は EventSubscriber が処理。
  if ($form_id === 'user_login_form') {
    $config = \Drupal::config('tfa_custom.settings');
    $redirect_path = $config->get('redirect_after_login') ?: '<front>';

    // パスワードリセットトークンがある場合は何もしない。
    $token = \Drupal::request()->get('pass-reset-token');
    if ($token) {
      return;
    }

    // デフォルト設定の場合は何もしない（Drupalのデフォルト動作を使用）。
    if ($redirect_path === '<front>') {
      return;
    }

    // destination hidden フィールドを追加（Drupalが自動的に処理）。
    $form['destination'] = [
      '#type' => 'hidden',
      '#value' => $redirect_path,
    ];
  }
}

/**
 * Implements hook_mail_alter().
 *
 * TFAのメール送信を制御。
 */
function tfa_custom_mail_alter(&$message) {
  // TFAモジュールからのメールのみを対象とする。
  if ($message['module'] !== 'tfa') {
    return;
  }

  $config = \Drupal::config('tfa_custom.settings');

  // TFA有効化メールの制御。
  if ($message['key'] === 'tfa_enabled_configuration') {
    $send_email = $config->get('send_email_on_enable') ?? TRUE;
    if (!$send_email) {
      $message['send'] = FALSE;
    }
  }

  // TFA無効化メールの制御。
  if ($message['key'] === 'tfa_disabled_configuration') {
    $send_email = $config->get('send_email_on_disable') ?? TRUE;
    if (!$send_email) {
      $message['send'] = FALSE;
    }
  }
}
